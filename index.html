<script>
    // 1. SUPABASE SUBSCRIPTION LOGIC (Unchanged)
    const SUPABASE_URL = "https://jcrsdyyqrbtxyzhveszx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_oQOSOkFpJAPfmnINrAYYUg_FNMRBM1h"; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');

    submitBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      if (!email || !email.includes('@')) {
        statusDiv.textContent = "Please enter a valid email address.";
        statusDiv.className = "status-msg status-error";
        return;
      }

      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Processing...";

      const { error } = await _supabase.from('subscribers').insert([{ email: email }]);

      if (error) {
        if (error.code === '23505') { 
          statusDiv.textContent = "This email is already subscribed.";
          statusDiv.className = "status-msg status-success";
        } else {
          statusDiv.textContent = "Error joining list. Please try again.";
          statusDiv.className = "status-msg status-error";
          console.error(error);
        }
      } else {
        statusDiv.textContent = "Success! You are now subscribed.";
        statusDiv.className = "status-msg status-success";
        emailInput.value = "";
      }
      
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }, 2000);
    });

    // 2. LIVE FEED LOGIC (STRICT REAL DATA ONLY)
    async function initLiveMockup() {
        const feedContainer = document.getElementById('live-feed-container');
        const subjectLine = document.getElementById('live-subject');
        const dateDisplay = document.getElementById('live-date');
        
        // Helper: Format relative time (e.g. "2 hours ago")
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mins ago";
            return "Just now";
        }

        try {
            // Set initial loading state
            feedContainer.innerHTML = '<div class="bill-item" style="color:#94a3b8; font-style:italic;">Connecting to House Clerk server...</div>';
            
            // Use public RSS-to-JSON bridge
            const RSS_URL = "https://docs.house.gov/BillsThisWeek-RSS.xml";
            const API_ENDPOINT = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(RSS_URL)}`;
            
            const response = await fetch(API_ENDPOINT);
            const data = await response.json();

            if (data.status === 'ok' && data.items && data.items.length > 0) {
                // SUCCESS: Clear loading and show REAL data
                feedContainer.innerHTML = '';
                
                // Update timestamp to now
                const now = new Date();
                dateDisplay.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Take top 3 items
                const items = data.items.slice(0, 3);
                
                // Update Subject Line
                subjectLine.innerText = `House Floor updates: ${items.length} items (Live)`;

                items.forEach(item => {
                    // Clean the title: remove "Added:" or "Updated:" prefix
                    let cleanTitle = item.title.replace(/^(Added|Updated):?\s*/i, '').trim();
                    let dateObj = new Date(item.pubDate);
                    
                    const div = document.createElement('div');
                    div.className = 'bill-item';
                    
                    // Determine tag type
                    let tagHtml = `<span class="tag">LINK</span>`;
                    if (item.link.toLowerCase().endsWith('pdf')) tagHtml = `<span class="tag">PDF</span>`;
                    if (item.link.toLowerCase().endsWith('xml')) tagHtml = `<span class="tag">XML</span>`;

                    div.innerHTML = `
                        <div class="bill-title">${cleanTitle} ${tagHtml}</div>
                        <div class="bill-meta">${timeAgo(dateObj)} â€¢ ${dateObj.toLocaleDateString()}</div>
                    `;
                    feedContainer.appendChild(div);
                });
            } else {
                // FAILURE: Show honest empty state
                subjectLine.innerText = 'House Floor updates: No recent activity';
                feedContainer.innerHTML = '<div class="bill-item" style="color:#64748b;">No active items found in the current House feed.</div>';
            }
        } catch (e) {
            // ERROR: Show honest error state
            console.error("Feed Error:", e);
            subjectLine.innerText = 'House Floor updates: Connection Error';
            feedContainer.innerHTML = '<div class="bill-item" style="color:#dc2626;">Unable to reach docs.house.gov. <br><span style="font-size:11px; color:#999;">The House server may be blocking the connection.</span></div>';
        }
    }

    // Run the logic
    initLiveMockup();
  </script>
