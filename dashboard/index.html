<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Feed | The Capitol Wire</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0f172a;
      --accent: #1e3a8a;
      --light-blue: #3b82f6;
      --bg: #f8fafc;
      --text: #334155;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; color: var(--text); background: var(--bg); line-height: 1.4; }

    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

    nav { background: white; border-bottom: 1px solid var(--border); padding: 12px 0; margin-bottom: 25px; }
    .nav-inner { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-family: 'Merriweather', serif; font-weight: 900; font-size: 1.2rem; color: var(--primary); text-decoration: none; }
    .logo span { color: var(--light-blue); }
    .back-link { font-size: 0.9rem; color: var(--text); text-decoration: none; }
    .back-link:hover { text-decoration: underline; }

    /* UPDATE HEADER */
    .status-line { margin-bottom: 20px; text-align: right; font-size: 0.85rem; color: #64748b; font-weight: 500; }
    .status-line span { color: #dc2626; font-weight: 700; }

    .box-header { font-family: 'Merriweather', serif; font-size: 0.95rem; font-weight: 700; padding: 12px 20px; border-radius: 6px 6px 0 0; border: 1px solid; border-bottom: none; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .latest-box { margin-bottom: 25px; }
    .latest-box .box-header { background: #fffbeb; color: #92400e; border-color: #fcd34d; }
    .latest-box .feed-list { border-color: #fcd34d; }
    .schedule-box .box-header { background: white; color: var(--primary); border-color: var(--border); }
    
    .feed-list { border: 1px solid var(--border); border-radius: 0 0 6px 6px; background: white; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .category-header { background: #f8fafc; color: var(--accent); font-family: 'Merriweather', serif; font-weight: 700; font-size: 0.85rem; padding: 10px 20px; border-bottom: 1px solid var(--border); text-transform: uppercase; letter-spacing: 0.5px; margin-top: -1px; }

    .bill-item { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px; }
    .bill-item:last-child { border-bottom: none; }
    .bill-title { font-weight: 600; color: var(--primary); font-size: 0.95rem; line-height: 1.3; }
    .bill-meta { font-size: 0.75rem; color: #64748b; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .meta-cat { text-transform: uppercase; font-weight: 700; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; border: 1px solid #e2e8f0; }
    .meta-time { color: #dc2626; font-weight: 600; font-family: monospace; background: #fef2f2; padding: 1px 5px; border-radius: 3px; }
    .doc-link { margin-left: auto; background: #eff6ff; color: var(--accent); font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; text-decoration: none; font-weight: 600; border: 1px solid #dbeafe; }
    .doc-link:hover { background: #dbeafe; }
  </style>
</head>
<body>

  <nav>
    <div class="container nav-inner">
      <a href="index.html" class="logo">üèõÔ∏è The Capitol <span>Wire</span></a>
      <a href="index.html" class="back-link">‚Üê Main Site</a>
    </div>
  </nav>

  <div class="container">
    <div id="status-line" class="status-line">Loading...</div>

    <div class="latest-box" id="latest-container" style="display:none;">
      <div class="box-header">‚ö° LATEST ACTIVITY</div>
      <div class="feed-list" id="latest-list"></div>
    </div>

    <div class="schedule-box">
      <div class="box-header">üìã FULL SCHEDULE</div>
      <div class="feed-list" id="schedule-list">
        <div style="padding:40px; text-align:center; color:#94a3b8;">Loading data...</div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://jcrsdyyqrbtxyzhveszx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_oQOSOkFpJAPfmnINrAYYUg_FNMRBM1h"; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const CATEGORIES = [
        { key: 'Suspension', label: 'Items that may be considered under suspension of the rules' },
        { key: 'Rule', label: 'Items that may be considered pursuant to a rule' },
        { key: 'Possible Consideration', label: 'Items that may be considered' }
    ];

    async function initFeed() {
        const latestContainer = document.getElementById('latest-container');
        const latestList = document.getElementById('latest-list');
        const scheduleList = document.getElementById('schedule-list');
        const statusLine = document.getElementById('status-line');

        try {
            const { data, error } = await _supabase.from('live_feed').select('*').order('id', { ascending: true });

            if (data && data.length > 0) {
                scheduleList.innerHTML = '';
                latestList.innerHTML = '';
                
                const newestTimestamp = data[0].timestamp;
                if (newestTimestamp && newestTimestamp.trim() !== "") {
                    statusLine.innerHTML = "Last Updated: <span>" + newestTimestamp + "</span>";
                } else {
                    statusLine.innerText = "System Active";
                }

                let hasLatest = false;
                if (newestTimestamp && newestTimestamp.trim() !== "") {
                    data.forEach(item => {
                        if (item.timestamp === newestTimestamp) {
                            latestList.appendChild(createBillItem(item));
                            hasLatest = true;
                        }
                    });
                }
                if (hasLatest) { latestContainer.style.display = 'block'; }

                CATEGORIES.forEach(cat => {
                    const catItems = data.filter(i => i.category === cat.key);
                    if (catItems.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'category-header';
                        header.innerText = cat.label;
                        scheduleList.appendChild(header);
                        catItems.forEach(item => scheduleList.appendChild(createBillItem(item)));
                    }
                });
            } else {
                scheduleList.innerHTML = '<div style="padding:40px; text-align:center;">No active schedule.</div>';
            }
        } catch (e) { console.error(e); }
    }

    function createBillItem(item) {
        const div = document.createElement('div');
        div.className = 'bill-item';
        let linkHtml = '';
        if (item.link) {
            const isPdf = item.link.toLowerCase().endsWith('pdf');
            linkHtml = `<a href="${item.link}" target="_blank" class="doc-link">${isPdf ? 'PDF' : 'TEXT'}</a>`;
        }
        let timeHtml = '';
        if (item.timestamp && item.timestamp.trim() !== "") {
            timeHtml = `<span class="meta-time">${item.timestamp}</span>`;
        }
        div.innerHTML = `<div class="bill-title">${item.title}</div><div class="bill-meta"><span class="meta-cat">${item.category}</span>${timeHtml}${linkHtml}</div>`;
        return div;
    }
    initFeed();
  </script>
</body>
</html>
