<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CEV5ME0C6L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CEV5ME0C6L');
  </script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | The Capitol Wire</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0f172a; /* Navy */
      --header-bg: #1e3a8a; /* House Blue */
      --bg: #f3f4f6; /* Light Grey Background */
      --text: #1f2937;
      --border: #e5e7eb;
      --accent: #2563eb;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; color: var(--text); background: var(--bg); line-height: 1.5; }

    /* NAV BAR - MINIMAL RESTORED */
    nav { 
        background: var(--header-bg); 
        color: white; 
        padding: 15px 0; 
        border-bottom: 4px solid #1e40af;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .nav-inner { 
        max-width: 1200px; margin: 0 auto; padding: 0 20px; 
        display: flex; justify-content: space-between; align-items: center; 
    }
    .logo { 
        font-family: 'Merriweather', serif; font-weight: 700; font-size: 1.3rem; 
        color: white; text-decoration: none; display: flex; align-items: center; gap: 8px;
    }
    .sub-btn { background: white; color: var(--header-bg); padding: 5px 12px; border-radius: 4px; font-weight: 600; text-decoration: none; font-size: 0.85rem; border: none; cursor: pointer; }

    /* LAYOUT GRID */
    .main-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1fr 300px; /* Main Content | Sidebar */
        gap: 30px;
    }

    /* WEEKLY HEADER BOX */
    .week-header-box {
        background: white;
        padding: 20px 25px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .week-header-text {
        font-family: 'Merriweather', serif;
        font-size: 1.5rem;
        color: var(--primary);
        font-weight: 400; /* Regular weight like example */
    }

    /* MAIN FEED (LEFT COLUMN) */
    .status-bar {
        display: flex; align-items: center; gap: 10px;
        font-size: 0.85rem; color: #6b7280; margin-bottom: 20px;
        background: white; padding: 10px 15px; border-radius: 6px; border: 1px solid var(--border);
    }
    .live-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .feed-section { background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px; overflow: hidden; }
    .section-header {
        background: #f9fafb;
        padding: 12px 20px;
        font-family: 'Merriweather', serif;
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--primary);
        border-bottom: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .bill-item { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 5px; transition: background 0.1s; }
    .bill-item:last-child { border-bottom: none; }
    .bill-item:hover { background: #f8fafc; }
    
    .bill-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
    
    /* Bill Title Styling - Specific Bold Logic handled in JS/HTML */
    .bill-title { color: #111827; font-size: 1rem; line-height: 1.4; flex: 1; font-weight: 400; }
    .bill-title strong { font-weight: 700; color: var(--primary); }
    
    .bill-links { display: flex; gap: 8px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
    .doc-link { color: var(--accent); text-decoration: none; background: #eff6ff; padding: 2px 6px; border-radius: 4px; }
    .doc-link:hover { background: #dbeafe; }
    
    .bill-meta { font-size: 0.8rem; color: #6b7280; display: flex; align-items: center; gap: 10px; margin-top: 4px; }
    .meta-time { color: #dc2626; font-weight: 600; background: #fef2f2; padding: 1px 5px; border-radius: 3px; }

    /* SIDEBAR (RIGHT COLUMN) */
    .sidebar { display: flex; flex-direction: column; gap: 20px; }
    .widget { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .widget h3 { font-family: 'Merriweather', serif; font-size: 1rem; color: var(--header-bg); margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }

    /* CALENDAR WIDGET */
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cal-btn { background: none; border: none; font-weight: bold; cursor: pointer; color: var(--accent); font-size: 1.1rem; padding: 0 5px; }
    .cal-btn:hover { color: var(--primary); }
    .cal-month { font-weight: 700; color: var(--primary); }
    
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 0.8rem; }
    .cal-day-header { font-weight: 700; color: #6b7280; padding-bottom: 5px; }
    .cal-day { padding: 6px 0; color: #374151; border-radius: 4px; }
    
    /* Calendar Status Colors */
    .cal-session { background: #fcd34d; color: #92400e; font-weight: 700; } 
    .cal-today { border: 2px solid #2563eb; font-weight:900; } 
    
    /* RESOURCES WIDGET */
    .res-link { display: block; padding: 8px 0; color: var(--accent); text-decoration: none; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; }
    .res-link:last-child { border-bottom: none; }
    .res-link:hover { color: var(--header-bg); text-decoration: underline; }
    .res-desc { font-size: 0.75rem; color: #6b7280; margin-top: 2px; }

    /* MODAL */
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:100; }
    .modal { background:white; padding:30px; border-radius:10px; width:90%; max-width:400px; text-align:center; position:relative; }
    .close-modal { position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.5rem; color:#999; }
    .modal h3 { margin-bottom:15px; color:var(--primary); font-family: 'Merriweather', serif; }
    .modal input { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px; }
    .modal button { width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    .modal button:disabled { background: #94a3b8; }
    .modal-msg { margin-top:10px; font-size:0.85rem; }

    @media (max-width: 768px) {
        .main-container { grid-template-columns: 1fr; }
        .sidebar { order: -1; }
    }
  </style>
</head>
<body>

  <nav>
    <div class="nav-inner">
      <a href="/" class="logo">üèõÔ∏è The Capitol Wire</a>
      <button class="sub-btn" onclick="openModal()">Subscribe</button>
    </div>
  </nav>

  <div class="main-container">
    
    <div class="content-area">
        <div class="week-header-box">
            <h2 id="weekly-header" class="week-header-text">Text of Bills for the Week...</h2>
        </div>

        <div class="status-bar">
            <div class="live-dot"></div>
            <div id="status-line">System Active. Monitoring for updates...</div>
        </div>

        <div id="latest-container" class="feed-section" style="display:none; border-color:#fcd34d;">
            <div class="section-header" style="background:#fffbeb; color:#92400e; border-bottom-color:#fcd34d;">‚ö° Latest Activity (New)</div>
            <div id="latest-list"></div>
        </div>

        <div id="schedule-list">
            <div style="padding:40px; text-align:center; color:#94a3b8;">Loading legislative data...</div>
        </div>
    </div>

    <div class="sidebar">
        
        <div class="widget">
            <h3>Legislative Calendar</h3>
            <div class="cal-header">
                <button class="cal-btn" onclick="changeMonth(-1)">&lt;</button>
                <div id="calendar-month" class="cal-month">December 2025</div>
                <button class="cal-btn" onclick="changeMonth(1)">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <div class="cal-day-header">S</div>
                <div class="cal-day-header">M</div>
                <div class="cal-day-header">T</div>
                <div class="cal-day-header">W</div>
                <div class="cal-day-header">T</div>
                <div class="cal-day-header">F</div>
                <div class="cal-day-header">S</div>
                </div>
            <div style="font-size:0.75rem; color:#6b7280; margin-top:10px; text-align:center;">
                <span style="display:inline-block; width:8px; height:8px; background:#fcd34d; margin-right:4px; border-radius:2px;"></span> In Session
            </div>
        </div>

        <div class="widget">
            <h3>Online Resources</h3>
            <a href="https://clerk.house.gov/" target="_blank" class="res-link">
                Office of the Clerk
                <div class="res-desc">Official vote counts and floor proceedings.</div>
            </a>
            <a href="https://rules.house.gov/" target="_blank" class="res-link">
                Committee on Rules
                <div class="res-desc">Texts of rules and amendments.</div>
            </a>
            <a href="https://www.majorityleader.gov/schedule/weekly-schedule.htm" target="_blank" class="res-link">
                Majority Leader's Schedule
                <div class="res-desc">Weekly outlook and colloquy.</div>
            </a>
        </div>

    </div>
  </div>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3>Get Instant Alerts</h3>
      <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Enter your email to get notified when the schedule changes.</p>
      <input type="email" id="modal-email" placeholder="Your Email Here" />
      <button id="modal-submit">Subscribe Free</button>
      <div id="modal-status" class="modal-msg"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://jcrsdyyqrbtxyzhveszx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_oQOSOkFpJAPfmnINrAYYUg_FNMRBM1h"; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const CATEGORIES = [
        { key: 'Suspension', label: 'Items that may be considered under suspension of the rules' },
        { key: 'Rule', label: 'Items that may be considered pursuant to a rule' },
        { key: 'Possible Consideration', label: 'Items that may be considered' }
    ];

    let lastKnownTimestamp = "";

    // --- 1. DYNAMIC WEEKLY HEADER ---
    function setWeeklyHeader() {
        // Calculate the "Monday" of the current week
        const d = new Date();
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1); // Adjust when day is Sunday
        const monday = new Date(d.setDate(diff));
        
        const options = { month: 'short', day: 'numeric', year: 'numeric' };
        const weekStr = monday.toLocaleDateString('en-US', options);
        
        document.getElementById('weekly-header').innerText = "Text of Bills for the Week of " + weekStr;
    }
    setWeeklyHeader();


    // --- 2. CLICKABLE CALENDAR LOGIC ---
    let calendarCursor = new Date(); // Keeps track of displayed month

    // Hardcoded Session Dates (2025-2026)
    const SESSION_DATES = [
        "2025-12-01", "2025-12-02", "2025-12-03", "2025-12-04",
        "2025-12-08", "2025-12-09", "2025-12-10", "2025-12-11",
        "2025-12-15", "2025-12-16", "2025-12-17", "2025-12-18",
        
        // 2026 HOUSE CALENDAR
        "2026-01-06", "2026-01-07", "2026-01-08", "2026-01-09",
        "2026-01-12", "2026-01-13", "2026-01-14", "2026-01-15",
        "2026-01-20", "2026-01-21", "2026-01-22",
        "2026-01-26", "2026-01-27", "2026-01-28", "2026-01-29", "2026-01-30",
        "2026-02-02", "2026-02-03", "2026-02-04", "2026-02-05",
        "2026-02-09", "2026-02-10", "2026-02-11", "2026-02-12",
        "2026-02-24", "2026-02-25", "2026-02-26",
        "2026-03-02", "2026-03-03", "2026-03-04", "2026-03-05",
        "2026-03-09", "2026-03-10", "2026-03-11", "2026-03-12",
        "2026-03-16", "2026-03-17", "2026-03-18", "2026-03-19",
        "2026-03-23", "2026-03-24", "2026-03-25", "2026-03-26",
        "2026-04-13", "2026-04-14", "2026-04-15", "2026-04-16",
        "2026-04-20", "2026-04-21", "2026-04-22", "2026-04-23",
        "2026-04-28", "2026-04-29", "2026-04-30"
        // Add more 2026 dates here if needed
    ];
    const SESSION_SET = new Set(SESSION_DATES);

    function changeMonth(delta) {
        calendarCursor.setMonth(calendarCursor.getMonth() + delta);
        renderCalendar();
    }

    function renderCalendar() {
        const year = calendarCursor.getFullYear();
        const month = calendarCursor.getMonth();
        const todayObj = new Date();

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('calendar-month').innerText = monthNames[month] + " " + year;
        
        const grid = document.getElementById('calendar-grid');
        while (grid.children.length > 7) { grid.removeChild(grid.lastChild); }

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Empty slots
        for (let i = 0; i < firstDay; i++) {
            const div = document.createElement('div');
            grid.appendChild(div);
        }

        // Days
        for (let i = 1; i <= daysInMonth; i++) {
            const div = document.createElement('div');
            div.className = 'cal-day';
            div.innerText = i;
            
            const monthStr = (month + 1).toString().padStart(2, '0');
            const dayStr = i.toString().padStart(2, '0');
            const dateString = `${year}-${monthStr}-${dayStr}`;

            if (SESSION_SET.has(dateString)) {
                div.classList.add('cal-session');
            }

            // Check if it's actually today
            if (year === todayObj.getFullYear() && month === todayObj.getMonth() && i === todayObj.getDate()) {
                div.classList.add('cal-today');
            }
            
            grid.appendChild(div);
        }
    }
    renderCalendar();

    // --- 3. FEED LOGIC (With Smart Title Boldness) ---
    async function initFeed() {
        const latestContainer = document.getElementById('latest-container');
        const latestList = document.getElementById('latest-list');
        const scheduleList = document.getElementById('schedule-list');
        const statusLine = document.getElementById('status-line');

        try {
            const { data, error } = await _supabase.from('live_feed').select('*').order('id', { ascending: true });

            if (data && data.length > 0) {
                const newestTimestamp = data[0].timestamp;
                
                if (newestTimestamp !== lastKnownTimestamp) {
                    lastKnownTimestamp = newestTimestamp;
                    scheduleList.innerHTML = '';
                    latestList.innerHTML = '';
                    
                    if (newestTimestamp && newestTimestamp.trim() !== "") {
                        statusLine.innerHTML = "Last update from the Clerk: <b>" + newestTimestamp + "</b>";
                    }

                    let hasLatest = false;
                    if (newestTimestamp && newestTimestamp.trim() !== "") {
                        data.forEach(item => {
                            if (item.timestamp === newestTimestamp) {
                                latestList.appendChild(createBillItem(item));
                                hasLatest = true;
                            }
                        });
                    }
                    latestContainer.style.display = hasLatest ? 'block' : 'none';

                    CATEGORIES.forEach(cat => {
                        const catItems = data.filter(i => i.category === cat.key);
                        if (catItems.length > 0) {
                            const section = document.createElement('div');
                            section.className = 'feed-section';
                            
                            const header = document.createElement('div');
                            header.className = 'section-header';
                            header.innerText = cat.label;
                            section.appendChild(header);
                            
                            catItems.forEach(item => section.appendChild(createBillItem(item)));
                            scheduleList.appendChild(section);
                        }
                    });
                }
            } else {
                scheduleList.innerHTML = '<div style="padding:40px; text-align:center;">No active schedule.</div>';
            }
        } catch (e) { console.error(e); }
    }

    function createBillItem(item) {
        const div = document.createElement('div');
        div.className = 'bill-item';
        
        let linkHtml = '';
        if (item.link) {
            const isPdf = item.link.toLowerCase().endsWith('pdf');
            linkHtml = `<div class="bill-links"><a href="${item.link}" target="_blank" class="doc-link">${isPdf ? 'PDF' : 'TEXT'}</a></div>`;
        }
        
        let timeHtml = '';
        if (item.timestamp && item.timestamp.trim() !== "") {
            timeHtml = `<div class="bill-meta">Updated: <span class="meta-time">${item.timestamp}</span></div>`;
        }

        // --- TITLE PARSING LOGIC ---
        // We look for an "em-dash" (‚Äî) or a "hyphen" (-) 
        // Example: "H.R. 972 ‚Äî Sloan Canyon Act"
        let fullTitle = item.title;
        let boldPart = fullTitle;
        let normalPart = "";

        // Check for em-dash first (common in these feeds)
        let splitIndex = fullTitle.indexOf("‚Äî");
        if (splitIndex === -1) splitIndex = fullTitle.indexOf("-");

        if (splitIndex !== -1) {
            // Include the dash in the normal part? Or keep it separate?
            // User example: "S. 222" bold, "‚Äî Whole Milk" normal
            boldPart = fullTitle.substring(0, splitIndex).trim(); 
            normalPart = fullTitle.substring(splitIndex); // Includes the dash
        }

        div.innerHTML = `
            <div class="bill-row">
                <div class="bill-title"><strong>${boldPart}</strong> ${normalPart}</div>
                ${linkHtml}
            </div>
            ${timeHtml}
        `;
        return div;
    }
    
    initFeed();
    setInterval(initFeed, 10000);

    // MODAL LOGIC
    const modal = document.getElementById('modal');
    const modalInput = document.getElementById('modal-email');
    const modalBtn = document.getElementById('modal-submit');
    const modalStatus = document.getElementById('modal-status');

    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }
    
    window.addEventListener('load', () => { setTimeout(openModal, 2000); });

    modalBtn.addEventListener('click', async () => {
        const email = modalInput.value.trim();
        if (!email || !email.includes('@')) {
            modalStatus.innerText = "Please enter a valid email.";
            modalStatus.style.color = "#dc2626";
            return;
        }
        modalBtn.disabled = true;
        modalBtn.innerText = "Processing...";
        modalStatus.innerText = "";

        const { error } = await _supabase.from('subscribers').insert([{ email: email }]);
        
        if (error) {
            if (error.code === '23505') {
                modalStatus.innerText = "You are already subscribed!";
                modalStatus.style.color = "#2563eb";
            } else {
                modalStatus.innerText = "Error. Try again.";
                modalStatus.style.color = "#dc2626";
            }
            modalBtn.disabled = false;
            modalBtn.innerText = "Subscribe Free";
        } else {
            modalStatus.innerText = "Subscribed!";
            modalStatus.style.color = "#16a34a";
            modalInput.value = "";
            setTimeout(closeModal, 2000);
        }
    });
  </script>
</body>
</html>
